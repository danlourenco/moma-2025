# MoMA 2025 - Museum Platform as a Service

## Project Background

**Original Vision:** A personal AI-assisted art gallery created for my infant son, where children's artwork receives sophisticated art critiques generated by AI.

**Evolution:** Transform the personal gallery into a multi-user platform where **anyone can create an account, log in, and create "exhibits"** composed of individual artworks. Think "DeviantArt for families" - a platform for showcasing and discovering art with AI-powered curation tools.

### Current Architecture (Legacy)
```
moma-backend/    # Hono + Cloudflare Workers API
moma-ui/         # Nuxt 3.11.2 + Netlify Edge frontend
```

**Issues with Current Setup:**
- Severely outdated dependencies (Nuxt 3.11.2 â†’ 4.0.3 available)
- Infrastructure split across platforms (Cloudflare + Netlify)
- No multi-user support
- Manual deployment complexity
- Security vulnerabilities in dependencies

---

## Desired Goals

### Core Platform Features
1. **Multi-User Architecture**: Users create accounts and manage their own galleries
2. **Exhibit System**: Users organize artworks into themed exhibits (e.g., "My Child's First Year", "Abstract Experiments")
3. **AI-Powered Descriptions**: Streaming AI-generated art critiques with real-time typewriter effects
4. **Social Discovery**: Public galleries, search, featured exhibits, likes/shares
5. **Modern UX**: Mobile-responsive, PWA-capable, fast loading

### Technical Goals
1. **Modern Stack**: Latest Nuxt 4.x + NuxtHub + Better Auth
2. **Unified Platform**: Single Cloudflare-based infrastructure
3. **Streaming AI**: Real-time AI responses with proper UX
4. **Multi-Environment**: Idiomatic staging/production setup
5. **Scalable**: Edge-first architecture supporting growth

### User Experience Goals
1. **Instant Signup**: Social login with Google/GitHub
2. **Drag-and-Drop**: Easy artwork upload and organization
3. **Real-time AI**: Watch art descriptions generate live
4. **Mobile-First**: Optimized for phone photography workflows
5. **Shareable**: Beautiful exhibit URLs for social sharing

---

## Migration Gameplan

### Phase 1: Foundation Setup (Week 1)
**Goal: Modern NuxtHub project with authentication**

#### Setup Tasks:
```bash
# 1. Initialize NuxtHub project
npx nuxi@latest init moma-2025
cd moma-2025

# 2. Install core dependencies
npm install @nuxthub/core better-auth
npm install @nuxtjs/tailwindcss @formkit/nuxt @pinia/nuxt
npm install @heroicons/vue @nuxt/image nanoid zod

# 3. Development dependencies
npm install -D @types/uuid playwright
```

#### Configuration:
- Set up NuxtHub with database, blob storage, and AI
- Configure Better Auth with Google OAuth
- Establish environment-aware configuration
- Create database schema with migrations

**Deliverable:** Working auth system with user registration

### Phase 2: Core Artwork Functionality (Week 2)
**Goal: Users can upload artworks and generate streaming AI descriptions**

#### Key Features:
- File upload with validation and R2 storage
- Streaming AI description generation using NuxtHub AI
- Real-time updates with Server-Sent Events
- Basic artwork management (CRUD operations)

**Deliverable:** Users can upload artworks with AI-generated descriptions

### Phase 3: Exhibit Management (Week 3) 
**Goal: Users can create and organize exhibits with multiple artworks**

#### Key Features:
- Exhibit builder interface with drag-and-drop
- Artwork selection and organization
- Public/private exhibit settings
- Exhibit preview and management

**Deliverable:** Users can create organized exhibits with multiple artworks

### Phase 4: Public Gallery & Discovery (Week 4)
**Goal: Public browsing, featured exhibits, search functionality**

#### Key Features:
- Public gallery with exhibit browsing
- Search and filtering capabilities
- Featured exhibits system
- Social features (likes, shares)
- Individual exhibit viewer with optimized UX

**Deliverable:** Public gallery with search, filtering, and social features

### Phase 5: Enhanced Features & Polish (Week 5)
**Goal: Advanced features, mobile optimization, performance**

#### Key Features:
- Audio narration using AI text-to-speech
- Advanced social features (comments, following)
- Admin dashboard for content moderation
- Mobile PWA capabilities
- Performance optimization and monitoring

**Deliverable:** Production-ready platform with advanced features

---

## Idiomatic Multi-Environment Strategy

### Core Principle: Git-First, Branch-Based Environments
**Single NuxtHub Project + Git Branches + Cloudflare Pages = Perfect Multi-Environment Setup**

```
main branch        â†’ Production (moma.pages.dev)
staging branch     â†’ Staging (staging.moma.pages.dev)
feature/* branches â†’ Preview (hash.moma.pages.dev)
```

### Why This Approach is Idiomatic:
- âœ… Leverages Cloudflare Pages' native branch deployment system
- âœ… Zero configuration required for environment creation
- âœ… Automatic preview URLs for every branch/PR
- âœ… Native environment variable separation (Production vs Preview)
- âœ… Follows standard Git-flow patterns developers expect
- âœ… Cost-efficient with automatic scaling

### Environment-Aware Configuration

```typescript
// nuxt.config.ts - Environment detection using Cloudflare's built-in variables
export default defineNuxtConfig({
  hub: {
    database: true,
    blob: true,
    ai: true
  },

  runtimeConfig: {
    // Server-side variables (different per environment)
    authSecret: process.env.AUTH_SECRET,
    googleClientSecret: process.env.GOOGLE_CLIENT_SECRET,
    
    public: {
      // Cloudflare provides these automatically
      appEnv: process.env.CF_PAGES_BRANCH || 'development',
      commitSha: process.env.CF_PAGES_COMMIT_SHA,
      branch: process.env.CF_PAGES_BRANCH,
      
      // Feature flags based on environment
      enableDebugMode: process.env.CF_PAGES_BRANCH !== 'main',
      enableBetaFeatures: ['staging', 'develop'].includes(process.env.CF_PAGES_BRANCH || ''),
    }
  }
})
```

### Database Strategy: Single Database with Environment Prefixing

```typescript
// Environment-aware database tables
export function getTableName(baseTable: string) {
  const env = process.env.CF_PAGES_BRANCH || 'development'
  
  // Production uses clean table names
  if (env === 'main') return baseTable
  
  // Other environments get prefixed tables  
  return `${env}_${baseTable}`
}

// Usage: Automatic table isolation per environment
const tableName = getTableName('users') // main: 'users', staging: 'staging_users'
```

### Git Workflow with Conventional Commits
```bash
# Feature development with conventional commits
git checkout -b feature/user-profiles

# All commits must follow conventional commit format:
git commit -m "feat: add user profile management system"
git commit -m "style: improve profile form layout and spacing"
git commit -m "fix: resolve avatar upload validation issue"
git commit -m "docs: add user profile API documentation"

git push origin feature/user-profiles
# â†’ Automatically creates: random-hash.moma.pages.dev

# Staging validation  
git checkout staging
git merge feature/user-profiles
git push origin staging
# â†’ Automatically updates: staging.moma.pages.dev

# Production release
git checkout main
git merge staging
git push origin main
# â†’ Automatically updates: moma.pages.dev
```

#### **Conventional Commit Requirements**
All commits must follow the [Conventional Commits](https://conventionalcommits.org/) specification:

**Format:** `<type>[optional scope]: <description>`

**Required Types:**
- `feat`: New features
- `fix`: Bug fixes
- `docs`: Documentation changes
- `style`: Code style changes (formatting, missing semi-colons, etc)
- `refactor`: Code refactoring without changing functionality
- `perf`: Performance improvements
- `test`: Adding or updating tests
- `chore`: Maintenance tasks, dependency updates

**Examples:**
```bash
feat(auth): add Google OAuth integration
fix(upload): resolve file validation for large images
docs(api): update artwork endpoint documentation
style(components): improve button hover states
refactor(db): optimize exhibit query performance
perf(images): add lazy loading for artwork gallery
test(auth): add integration tests for login flow
chore(deps): update NuxtHub to latest version
```

**Benefits:**
- âœ… **Automated changelog generation** from commit messages
- âœ… **Semantic versioning** based on commit types
- âœ… **Clear commit history** for debugging and reviews
- âœ… **Better collaboration** with standardized messaging
- âœ… **Release automation** using conventional commit parsing

---

## Git Tag/Semantic Versioning Strategy

### **Simplified Versioning: `v{MAJOR}.{MINOR}.{PATCH}`**

**Practical approach for personal project - no ceremony, full automation.**

#### **Version Progression**
```
v0.1.0    # Phase 1 complete (auth system)
v0.2.0    # Phase 2 complete (artwork upload)
v0.3.0    # Phase 3 complete (exhibits)  
v0.4.0    # Phase 4 complete (public gallery)
v1.0.0    # Production ready ðŸš€
v1.1.0    # First feature addition
v1.1.1    # Bug fix
```

**Simple rule:** Stay in `v0.x.x` until production ready, then conservative major bumps only for breaking changes.

#### **Automated Version Bumping Rules**
| Commit Type | Version Bump | Example |
|-------------|-------------|---------|
| `feat:` | **MINOR** | `v1.1.0 â†’ v1.2.0` |
| `fix:` | **PATCH** | `v1.1.0 â†’ v1.1.1` |
| `feat!:` or `BREAKING CHANGE:` | **MAJOR** | `v1.1.0 â†’ v2.0.0` |
| `chore:`, `docs:`, `style:`, etc. | **PATCH** | `v1.1.0 â†’ v1.1.1` |

#### **Fully Automated Workflow**
```yaml
# .github/workflows/release.yml
name: Release
on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build and test
        run: |
          npm run build
          npm run test
          
      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

#### **Package.json Configuration**
```json
{
  "release": {
    "branches": ["main"],
    "plugins": [
      "@semantic-release/commit-analyzer",
      "@semantic-release/release-notes-generator", 
      "@semantic-release/changelog",
      "@semantic-release/github",
      "@semantic-release/git"
    ]
  }
}
```

#### **Auto-Generated Changelog Example**
```markdown
# Changelog

## [0.4.0] - 2025-08-15
### Features
- Public gallery with search and filtering
- Social features (likes, shares)
- Featured exhibits system

### Bug Fixes  
- Image upload validation for mobile devices
- Gallery layout on small screens

## [0.3.0] - 2025-08-08
### Features
- Exhibit creation and management
- Drag-and-drop artwork organization
- Public/private exhibit settings
```

**Workflow:** Write conventional commits â†’ Push to main â†’ GitHub Action automatically determines version, creates tag, generates changelog, and deploys.

### Environment Variables (Cloudflare Pages Dashboard)
```bash
# Production Environment (main branch)
AUTH_SECRET=prod_secret_xyz
GOOGLE_CLIENT_SECRET=prod_google_secret
BETTER_AUTH_URL=https://moma.pages.dev

# Preview Environment (all other branches)
AUTH_SECRET=preview_secret_abc  
GOOGLE_CLIENT_SECRET=staging_google_secret
BETTER_AUTH_URL=https://staging.moma.pages.dev
```

---

## Authentication Plan with Better Auth

### Why Better Auth over Alternatives?

**Better Auth** is chosen over NextAuth/Auth0/Supabase Auth because:
- âœ… **Framework-agnostic**: Works perfectly with Nuxt
- âœ… **TypeScript-first**: Excellent type safety and DX
- âœ… **Database-agnostic**: Works with NuxtHub's D1 database
- âœ… **Extensible**: Plugin ecosystem for advanced features
- âœ… **Modern**: Built for current web standards and practices
- âœ… **Self-hosted**: Full control over user data and flows

### Authentication Strategy

#### Core Authentication Methods:
1. **Email/Password** - Traditional signup flow
2. **Google OAuth** - Primary social login (family-friendly)
3. **GitHub OAuth** - For developer/creator audience
4. **Magic Links** - Passwordless option for ease of use

#### Future Authentication Enhancements:
- **Email OTP** - SMS-like experience without phone numbers
- **Passkeys** - Modern, secure authentication
- **Apple Sign-In** - iOS-friendly option

### Better Auth Setup

#### 1. Installation and Basic Setup
```bash
npm install better-auth
npm install @better-auth/nuxt  # Nuxt integration
```

#### 2. Environment Configuration
```bash
# .env
AUTH_SECRET=your-secret-key-here
GOOGLE_CLIENT_ID=your-google-client-id  
GOOGLE_CLIENT_SECRET=your-google-client-secret
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
BETTER_AUTH_URL=http://localhost:3000  # or production URL
```

#### 3. Database Schema
```sql
-- Better Auth will generate these tables
CREATE TABLE user (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  image TEXT,
  emailVerified INTEGER,
  createdAt INTEGER,
  updatedAt INTEGER
);

CREATE TABLE session (
  id TEXT PRIMARY KEY,
  userId TEXT NOT NULL,
  expiresAt INTEGER NOT NULL,
  ipAddress TEXT,
  userAgent TEXT,
  FOREIGN KEY (userId) REFERENCES user (id) ON DELETE CASCADE
);

CREATE TABLE account (
  id TEXT PRIMARY KEY,
  userId TEXT NOT NULL,
  providerId TEXT NOT NULL,
  providerUserId TEXT NOT NULL,
  accessToken TEXT,
  refreshToken TEXT,
  expiresAt INTEGER,
  createdAt INTEGER,
  updatedAt INTEGER,
  FOREIGN KEY (userId) REFERENCES user (id) ON DELETE CASCADE
);
```

#### 4. Server Configuration
```typescript
// server/api/auth/[...auth].ts
import { betterAuth } from 'better-auth'
import { drizzleAdapter } from 'better-auth/adapters/drizzle'
import { db } from '~/server/utils/db'

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: 'sqlite'
  }),
  
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
    github: {
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }
  },
  
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true
  },
  
  plugins: [
    // Add plugins as needed
  ]
})

export default defineEventHandler(async (event) => {
  return auth.handler(toWebRequest(event))
})
```

#### 5. Client Setup
```typescript
// plugins/auth.client.ts
import { createAuthClient } from 'better-auth/client'

export const authClient = createAuthClient({
  baseURL: process.env.BETTER_AUTH_URL || 'http://localhost:3000'
})

// composables/useAuth.ts
export const useAuth = () => {
  const user = ref(null)
  const loading = ref(true)

  const signIn = async (email: string, password: string) => {
    return await authClient.signIn.email({ email, password })
  }

  const signUp = async (email: string, password: string, name: string) => {
    return await authClient.signUp.email({ email, password, name })
  }

  const signOut = async () => {
    await authClient.signOut()
    user.value = null
  }

  const signInWithGoogle = async () => {
    return await authClient.signIn.social({ provider: 'google' })
  }

  const signInWithGitHub = async () => {
    return await authClient.signIn.social({ provider: 'github' })
  }

  return {
    user: readonly(user),
    loading: readonly(loading),
    signIn,
    signUp,
    signOut,
    signInWithGoogle,
    signInWithGitHub
  }
}
```

#### 6. Authentication Components
```vue
<!-- components/AuthModal.vue -->
<template>
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-center mb-6">
        {{ isLogin ? 'Welcome Back' : 'Create Account' }}
      </h2>

      <!-- Social Login Buttons -->
      <div class="space-y-3 mb-6">
        <button 
          @click="signInWithGoogle"
          class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 rounded-lg px-4 py-3 hover:bg-gray-50 transition-colors"
        >
          <GoogleIcon class="w-5 h-5" />
          Continue with Google
        </button>
        
        <button 
          @click="signInWithGitHub"
          class="w-full flex items-center justify-center gap-3 bg-gray-900 text-white rounded-lg px-4 py-3 hover:bg-gray-800 transition-colors"
        >
          <GitHubIcon class="w-5 h-5" />
          Continue with GitHub
        </button>
      </div>

      <div class="relative mb-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300" />
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white text-gray-500">Or continue with email</span>
        </div>
      </div>

      <!-- Email/Password Form -->
      <form @submit.prevent="handleSubmit" class="space-y-4">
        <div v-if="!isLogin">
          <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input
            v-model="form.name"
            type="text"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Your name"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input
            v-model="form.email"
            type="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="your@email.com"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input
            v-model="form.password"
            type="password"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          />
        </div>

        <button
          type="submit"
          :disabled="loading"
          class="w-full bg-blue-600 text-white rounded-lg px-4 py-3 hover:bg-blue-700 transition-colors disabled:opacity-50"
        >
          {{ loading ? 'Loading...' : (isLogin ? 'Sign In' : 'Create Account') }}
        </button>
      </form>

      <div class="mt-6 text-center">
        <button 
          @click="isLogin = !isLogin"
          class="text-blue-600 hover:text-blue-800 text-sm"
        >
          {{ isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in" }}
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
const { signIn, signUp, signInWithGoogle, signInWithGitHub } = useAuth()

const isLogin = ref(true)
const loading = ref(false)
const form = reactive({
  name: '',
  email: '',
  password: ''
})

const handleSubmit = async () => {
  loading.value = true
  try {
    if (isLogin.value) {
      await signIn(form.email, form.password)
    } else {
      await signUp(form.email, form.password, form.name)
    }
    // Handle successful auth (redirect, close modal, etc.)
  } catch (error) {
    // Handle error (show message, etc.)
  } finally {
    loading.value = false
  }
}
</script>
```

#### 7. Protected Routes and Middleware
```typescript
// middleware/auth.ts
export default defineNuxtRouteMiddleware((to, from) => {
  const { user } = useAuth()
  
  if (!user.value) {
    return navigateTo('/login')
  }
})

// pages/dashboard.vue
<script setup>
definePageMeta({
  middleware: 'auth'
})
</script>
```

### User Experience Flow
1. **Landing Page**: Public gallery with "Sign Up" CTA
2. **Auth Modal**: Appears with social + email options
3. **Onboarding**: Welcome flow after first signup
4. **Dashboard**: User's personal exhibit management
5. **Profile**: Public profile with user's exhibits

### Security Considerations
- **CSRF Protection**: Built-in with Better Auth
- **Session Management**: Secure, HTTP-only cookies
- **Email Verification**: Required for email/password signup
- **Rate Limiting**: Implement on auth endpoints
- **Password Requirements**: Strong password validation

---

## Database Schema

### Core Tables
```sql
-- Users (managed by Better Auth)
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  display_name TEXT NOT NULL,
  avatar_url TEXT,
  bio TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Exhibits
CREATE TABLE exhibits (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  title TEXT NOT NULL,
  description TEXT,
  cover_image_url TEXT,
  is_public BOOLEAN DEFAULT false,
  is_featured BOOLEAN DEFAULT false,
  view_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Artworks
CREATE TABLE artworks (
  id TEXT PRIMARY KEY,
  exhibit_id TEXT NOT NULL REFERENCES exhibits(id),
  title TEXT NOT NULL,
  artist_name TEXT,
  medium TEXT,
  image_url TEXT NOT NULL,
  ai_description TEXT,
  audio_url TEXT,
  display_order INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Social features
CREATE TABLE exhibit_likes (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  exhibit_id TEXT NOT NULL REFERENCES exhibits(id),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, exhibit_id)
);
```

---

This document serves as the technical specification and roadmap for transforming the personal MoMA gallery into a scalable, multi-user art platform using modern web technologies and idiomatic Cloudflare/NuxtHub patterns.